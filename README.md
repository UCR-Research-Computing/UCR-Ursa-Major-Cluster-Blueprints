# UCR-Ursa-Major-Cluster-Templates

Templates for deploying instances of the UCR Ursa Major Cluster using the Google Cluster Toolkit (`gcluster`).

## Overview

This repository contains configuration blueprints designed to be used with the Google Cluster Toolkit. The `gcluster` tool simplifies the process of creating and managing HPC clusters on Google Cloud by handling the underlying Terraform generation and execution.

## Prerequisites

1.  **Google Cloud SDK:** Ensure you have `gcloud` installed and configured. Authenticate using:
    ```bash
    gcloud auth login
    gcloud auth application-default login
    ```
2.  **Google Cluster Toolkit:** Install or download the Cluster Toolkit. The commands below assume it's located at `~/cluster-toolkit/`. Adjust the path if yours is located elsewhere.
3.  **Project Permissions:** Ensure your authenticated user or service account has the necessary IAM permissions (e.g., Compute Admin, Service Account User, Project IAM Admin, or a suitable custom role) in the target Google Cloud project.
4.  **Blueprint Source:** You may need access to the repository containing the source blueprints (e.g., `UCR-Ursa-Major-Cluster-Blueprints`) if the path in the `create` command is relative.

## Usage

Deploying a cluster involves two main steps using the `gcluster` command:

1.  **Create Deployment Directory:**
    This step uses `gcluster create` to process a blueprint YAML file (like `UrsaMajor.yaml`) and generate a deployment directory. This directory contains the necessary configuration, including the generated Terraform code.

    ```bash
    # --- Configuration ---
    # Adjust the path to your cluster-toolkit installation if needed
    TOOLKIT_PATH="~/cluster-toolkit"

    # Set the path to the blueprint YAML file you want to use
    BLUEPRINT_FILE="UCR-Ursa-Major-Cluster-Blueprints/UrsaMajor.yaml"

    # Replace 'your-gcp-project-id' with your actual Google Cloud Project ID
    GCP_PROJECT_ID="your-gcp-project-id"
    # --- End Configuration ---

    # Run the gcluster create command
    ${TOOLKIT_PATH}/gcluster create "${BLUEPRINT_FILE}" \
      --vars project_id=${GCP_PROJECT_ID} \
      -l ERROR \
      -w
    ```
    * `BLUEPRINT_FILE`: Specifies the cluster configuration blueprint.
    * `--vars project_id=...`: Sets the target Google Cloud project ID.
    * `-l ERROR`: Sets the logging level to ERROR (can be adjusted, e.g., INFO, DEBUG).
    * `-w`: Instructs `gcluster` to create the deployment directory. The directory name is typically derived from the blueprint filename (e.g., `ursamajor` for `UrsaMajor.yaml`).

2.  **Deploy the Cluster:**
    This step uses `gcluster deploy` to take the configuration from the deployment directory created above and provision the actual cloud resources using Terraform.

    ```bash
    # --- Configuration ---
    # Adjust the path to your cluster-toolkit installation if needed
    TOOLKIT_PATH="~/cluster-toolkit"

    # Set the name of the deployment directory created by 'gcluster create'
    # (Usually the blueprint name, e.g., 'ursamajor' for UrsaMajor.yaml)
    DEPLOYMENT_DIR_NAME="ursamajor"
    # --- End Configuration ---

    # Run the gcluster deploy command
    ${TOOLKIT_PATH}/gcluster deploy "${DEPLOYMENT_DIR_NAME}" --auto-approve
    ```
    * `DEPLOYMENT_DIR_NAME`: The name of the directory generated by `gcluster create`.
    * `--auto-approve`: Automatically approves the Terraform apply step, skipping the interactive confirmation prompt. Remove this flag if you want to review the changes before applying.

## Cluster Management

* **Destroying the Cluster:** To remove all resources created for a deployment, use `gcluster delete`:
    ```bash
    # Adjust TOOLKIT_PATH and DEPLOYMENT_DIR_NAME as needed
    ${TOOLKIT_PATH}/gcluster delete "${DEPLOYMENT_DIR_NAME}" --auto-approve
    ```
* **Updating the Cluster:** Modify the blueprint YAML or toolkit variables and re-run `gcluster create` and `gcluster deploy`. Note that not all changes might be cleanly applied to an existing cluster; destruction and redeployment may sometimes be necessary for significant changes.
